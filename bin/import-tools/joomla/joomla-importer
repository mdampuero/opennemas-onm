#!/usr/bin/env php
<?php
/*
 * This file is part of the Onm package.
 *
 * (c)  Fran DiÃ©guez <frandieguez@gnome.org>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
define('DS', '/');

define('APPLICATION_PATH', realpath(__DIR__.'/../../../'));
define('SITE_PATH',        realpath(APPLICATION_PATH. DIRECTORY_SEPARATOR . "public" ).DIRECTORY_SEPARATOR);
define('SITE_LIBS_PATH',   realpath(SITE_PATH . "libs") . DIRECTORY_SEPARATOR);
define('SITE_VENDOR_PATH', realpath(APPLICATION_PATH.DIRECTORY_SEPARATOR."vendor").DIRECTORY_SEPARATOR);
define('SITE_CORE_PATH',   realpath(SITE_VENDOR_PATH.DIRECTORY_SEPARATOR."core").DIRECTORY_SEPARATOR);
define('SITE_MODELS_PATH', realpath(APPLICATION_PATH.DIRECTORY_SEPARATOR."app".DIRECTORY_SEPARATOR."models").DIRECTORY_SEPARATOR);
define('CACHE_PREFIX', 'joomla-importer');
error_reporting(E_ALL ^ E_NOTICE);

// Ensure library/ is on include_path
set_include_path(implode(PATH_SEPARATOR, array(
    SITE_CORE_PATH, SITE_LIBS_PATH, SITE_VENDOR_PATH, SITE_MODELS_PATH,
    '/usr/share/php/', '/usr/share/php/libzend-framework-php',  get_include_path(),
)));
require '/usr/share/php/libzend-framework-php/Zend/Console/Getopt.php';
require '/usr/share/php/libzend-framework-php/Zend/Console/Getopt/Exception.php';
require SITE_VENDOR_PATH.'/adodb5/adodb.inc.php';

$availableActions = array(
    'import-articles', 'show-categories', 'update-video', 'clear-database'
);

require APPLICATION_PATH.'/app/autoload.php';

require 'JoomlaImporter.php';

// Define short option
$config = array(
    'help|h'        => 'Show help',
    'verbose|v'     => 'Verbose mode',
    'action|a=s'    => 'Action to perform ['. implode(', ', $availableActions).' ]',
    'categories|c=s'    => 'Module (string)',
    'max|m=i'       => 'Maximum files',
    'limit|l=i'     => 'max id for import',
);

try {
    $options = new Zend_Console_Getopt($config);
    $options->parse();
    if (!empty($options->help)) {
        echo $options->getUsageMessage();
    } else {

        if (!empty($options->action)) {
            if (!in_array($options->action, $availableActions)) {
                throw new Zend_Console_Getopt_Exception('You must define a valid action: '.implode(', ',$availableActions));
            }

            try {
                JoomlaImporter::executeAction(
                    $options->action,
                    $options
                );

            } catch (\Exception $e) {
                echo "Exception: ".$e->getMessage();
            }

        } else {
            throw new Zend_Console_Getopt_Exception('You must define an action');
        }
        echo PHP_EOL;
    }
} catch (Zend_Console_Getopt_Exception $e) {
    echo $e->getMessage().PHP_EOL;
    echo $options->getUsageMessage();
}