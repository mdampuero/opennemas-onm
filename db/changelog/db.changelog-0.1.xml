<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">        
    
    <changeSet author="vifito" id="1271673432">
        <comment>Remove unsupported tables</comment>
        
        <dropTable tableName="attachments_contents_bak" />
        <!-- TODO: create rollback for all tables -->
        <!-- rollback changeSetId="1271672603790-9" changeSetAuthor="vifito"/ -->
        
        <dropTable tableName="bulletins_archive" />
        <dropTable tableName="events" />
        <dropTable tableName="newsletter_archive" />
        <dropTable tableName="pc_comments" />
        <dropTable tableName="pc_contents" />
        <dropTable tableName="pc_contents_categories" />
        <dropTable tableName="pc_content_categories" />
        <dropTable tableName="pc_content_types" />
        <dropTable tableName="pc_letters" />
        <dropTable tableName="pc_opinions" />
        <dropTable tableName="pc_photos" />
        <dropTable tableName="pc_privileges" />
        <dropTable tableName="pc_users" />
        <dropTable tableName="pc_user_groups" />
        <dropTable tableName="pc_user_groups_privileges" />
        <dropTable tableName="pc_videos" />
        <dropTable tableName="settings" />  
    </changeSet>
    
    <changeSet author="vifito" id="1271674998">
        <comment>Remove table polls, rename pc_polls to polls, change primary key and create index</comment>
        
        <dropTable tableName="polls" />
        <renameTable oldTableName="pc_polls" newTableName="polls"/>
        
        <renameColumn tableName="polls" oldColumnName="pk_pc_poll" newColumnName="pk_poll"
                      columnDataType="int unsigned" />
        
    </changeSet>
    
    
    <changeSet author="vifito" id="1271674999">
        <comment>Modify "primary key" columns</comment>                
        
        <modifyColumn tableName="advertisements">
            <column name="pk_advertisement" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        
        <modifyColumn tableName="albums">
            <column name="pk_album" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>        
        <modifyColumn tableName="albums_photos">
            <column name="pk_album" type="int unsigned" />                        
        </modifyColumn>
        <modifyColumn tableName="albums_photos">
            <column name="pk_photo" type="int unsigned" />                        
        </modifyColumn>
        
        <modifyColumn tableName="articles">
            <column name="pk_article" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>        
        <modifyColumn tableName="articles_clone">
            <column name="pk_original" type="int unsigned" />                        
        </modifyColumn>
        <modifyColumn tableName="articles_clone">
            <column name="pk_clone" type="int unsigned" />                        
        </modifyColumn>
        
        <modifyColumn tableName="attachments">
            <column name="pk_attachment" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        <modifyColumn tableName="attachments_contents">
            <column name="pk_attachment" type="int unsigned" />                        
        </modifyColumn>
        <modifyColumn tableName="attachments_contents">
            <column name="pk_content" type="int unsigned" />                        
        </modifyColumn>
        
        <modifyColumn tableName="author_imgs">
            <column name="pk_img" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        <modifyColumn tableName="author_imgs">
            <column name="fk_photo" type="int unsigned" />                        
        </modifyColumn>
        
        <modifyColumn tableName="comments">
            <column name="pk_comment" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        
        <modifyColumn tableName="contents">
            <column name="pk_content" type="int unsigned" autoIncrement="true">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        <modifyColumn tableName="contents_categories">
            <column name="pk_fk_content" type="int unsigned" />                        
        </modifyColumn>
        
        <modifyColumn tableName="img_galerys">
            <column name="pk_img" type="int unsigned" />                        
        </modifyColumn>
        <modifyColumn tableName="img_galerys">
            <column name="fk_pk_content" type="int unsigned" />                        
        </modifyColumn>
        
        <modifyColumn tableName="kioskos">
            <column name="pk_kiosko" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        
        <modifyColumn tableName="opinions">
            <column name="pk_opinion" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        
        <modifyColumn tableName="photos">
            <column name="pk_photo" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        
        <modifyColumn tableName="polls">
            <column name="pk_poll" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        <modifyColumn tableName="poll_items">
            <column name="fk_pk_poll" type="int unsigned" />                        
        </modifyColumn>
        
        <modifyColumn tableName="ratings">
            <column name="pk_rating" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        
        <modifyColumn tableName="related_contents">
            <column name="pk_content1" type="int unsigned"/>
            <column name="pk_content2" type="int unsigned"/>
        </modifyColumn>
        
        <modifyColumn tableName="static_pages">
            <column name="pk_static_page" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        
        <modifyColumn tableName="videos">
            <column name="pk_video" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>
        
        <modifyColumn tableName="votes">
            <column name="pk_vote" type="int unsigned">
                <constraints nullable="false"/>
            </column>                        
        </modifyColumn>        
    </changeSet>
    
    
    <changeSet author="vifito" id="1271676380">
        <comment>Remove table polls, rename pc_polls to polls and change primary key</comment>
        
        <dropColumn tableName="content_types" columnName="fk_template_default"/>
        
        <!-- Insert content_types {{{ -->
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="1"/>
            <column name="name" value="article"/>
            <column name="title" value="artigo"/>            
        </insert>
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="2"/>
            <column name="name" value="advertisement"/>
            <column name="title" value="publicidade"/>            
        </insert>        
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="3"/>
            <column name="name" value="attachment"/>
            <column name="title" value="ficheiro"/>            
        </insert>        
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="4"/>
            <column name="name" value="opinion"/>
            <column name="title" value="opinions"/>            
        </insert>
         
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="5"/>
            <column name="name" value="event"/>
            <column name="title" value="evento"/>            
        </insert>                      
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="6"/>
            <column name="name" value="comment"/>
            <column name="title" value="comentario"/>            
        </insert>    
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="7"/>
            <column name="name" value="album"/>
            <column name="title" value="album"/>            
        </insert>
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="8"/>
            <column name="name" value="photo"/>
            <column name="title" value="imaxe"/>            
        </insert>       
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="9"/>
            <column name="name" value="video"/>
            <column name="title" value="video"/>            
        </insert>
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="10"/>
            <column name="name" value="interviu"/>
            <column name="title" value="entrevista"/>            
        </insert>
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="11"/>
            <column name="name" value="poll"/>
            <column name="title" value="enquisa"/>            
        </insert>        
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="12"/>
            <column name="name" value="widget"/>
            <column name="title" value="widget"/>            
        </insert>
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="13"/>
            <column name="name" value="static_page"/>
            <column name="title" value="pÃ¡gina estÃ¡tica"/>            
        </insert>
        
        <insert tableName="content_types">
            <column name="pk_content_type" valueNumeric="14"/>
            <column name="name" value="kiosko"/>
            <column name="title" value="kiosko"/>            
        </insert>
        <!-- }}} -->
        
    </changeSet>
    
    
    <changeSet author="vifito" id="1271696048">
        <comment>Refactoring contents table</comment>
        
        <dropColumn tableName="contents" columnName="archive"/>
        <dropColumn tableName="contents" columnName="position"/>
        <dropColumn tableName="contents" columnName="frontpage"/>
        <dropColumn tableName="contents" columnName="in_home"/>
        <dropColumn tableName="contents" columnName="home_pos"/>
        <dropColumn tableName="contents" columnName="permalink"/>
        <dropColumn tableName="contents" columnName="available"/>
        <dropColumn tableName="contents" columnName="placeholder"/>
        <dropColumn tableName="contents" columnName="home_placeholder"/>
        <dropColumn tableName="contents" columnName="paper_page"/>
        <dropColumn tableName="contents" columnName="in_litter"/>
        
        <dropColumn tableName="contents" columnName="content_status"/>
        <addColumn tableName="contents">
            <column name="status" type="enum('PENDING','AVAILABLE','REMOVED')"/>
        </addColumn>
        
        <addColumn tableName="contents">
            <column name="published" type="datetime" />
        </addColumn>
        
        <addColumn tableName="contents">
            <column name="slug" type="varchar(255)">
                <constraints nullable="false"/> <!-- unique="true" --> 
            </column>
        </addColumn>
        
    </changeSet>
    
    
    <changeSet author="vifito" id="1271696783">        
        <comment>Create table for widget manager</comment>        
        
        <createTable tableName="widgets">
            <column name="pk_widget" type="int unsigned">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="content" type="text">
                <constraints nullable="false"/>
            </column>            
            <column name="renderlet" type="varchar(50)" defaultValue="html"/>            
        </createTable>        
        
        <rollback>
            <delete tableName="content_types">
                <where>pk_content_type=12</where>
            </delete>
            
            <dropTable tableName="widgets" />                        
        </rollback>
    </changeSet>
    
    
    <changeSet author="vifito" id="1271697241">        
        <comment>Table to associate a mask to a content</comment>
        
        <createTable tableName="masks">
            <column name="pk_mask" type="int unsigned" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="fk_content_type" type="int unsigned"/>
            <column name="name" type="varchar(255)"/>
            <column defaultValueBoolean="false" name="is_default" type="boolean"/>
        </createTable>
        
        <rollback>            
            <dropTable tableName="masks" />                        
        </rollback>
    </changeSet>
    
    
    <changeSet author="vifito" id="1271697640">        
        <comment>Initial table of pages</comment>
        
        <createTable tableName="pages">
            <column name="pk_page" type="int unsigned" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="fk_page" type="int unsigned" remarks="Parent page Id"
                    defaultValueNumeric="0" />
            
            <column name="title" type="varchar(255)"/>
            <column name="slug" type="varchar(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="text"/>
            <column name="keywords" type="text"/>
            
            <column name="visible" type="boolean"/>            
            <column name="type" type="varchar(50)" remarks="Type of a page"/>
            
            <column name="grid" type="varchar(50)" remarks="Name of css grid to use on page"/>
            <column name="theme" type="varchar(50)" remarks="Theme to use on page"/>            
            <column name="color" type="varchar(10)"/>
            
            <column name="params" type="text"/>            
        </createTable>
        
        <rollback>            
            <dropTable tableName="pages" />                        
        </rollback>
    </changeSet>
    

    <changeSet author="vifito" id="1271698759">        
        <comment>Table of contents_pages</comment>
        
        <createTable tableName="contents_pages">
            <column name="pk_fk_page" type="int unsigned">
                <constraints nullable="false"/>
            </column>
            <column name="pk_fk_content" type="int unsigned">
                <constraints nullable="false"/>
            </column>
            <column name="pk_placeholder" type="varchar(50)" remarks="Placeholder name">
                <constraints nullable="false"/>
            </column>
            <column name="pk_weight" type="int" remarks="Weight of content in a placeholder, negative values are permitted">
                <constraints nullable="false"/>
            </column>
            
            <column name="mask" type="varchar(255)" remarks="Name of the mask to use on content"/>
            <column name="params" type="text"/>
        </createTable>
        
        <addPrimaryKey tableName="contents_pages"
            columnNames="pk_fk_page,pk_fk_content,pk_placeholder,pk_weight"
            constraintName="pk_contents_pages"/>
        
        <rollback>            
            <dropTable tableName="contents_pages" />                        
        </rollback>
    </changeSet>
    
    <changeSet author="vifito" id="1271699102">        
        <comment>Rename contents_categories and content_categories fields</comment>
        
        <renameTable oldTableName="content_categories" newTableName="categories"/>
        <renameColumn tableName="categories" oldColumnName="pk_content_category"
                  newColumnName="pk_category" columnDataType="int unsigned"/>
        
        <renameColumn tableName="contents_categories" oldColumnName="pk_fk_content_category"
                  newColumnName="pk_fk_category" columnDataType="int unsigned"/>
        
    </changeSet>
    
    
    
    <changeSet author="vifito" id="1271699103">
        <comment>Fix index fields in articles_clone and attachments_contents</comment>
        
        <addPrimaryKey tableName="articles_clone"
            columnNames="pk_original,pk_clone"
            constraintName="pk_articles_clode"/>
        
        <addPrimaryKey tableName="attachments_contents"
            columnNames="pk_attachment,pk_content"
            constraintName="pk_attachments_contents"/>
        
    </changeSet>
    
    
    <changeSet author="vifito" id="1271699104">
        <comment>Rename pclave table to links</comment>
        
        <renameTable oldTableName="pclave" newTableName="links"/>
        
        <renameColumn tableName="links" oldColumnName="pclave"
                  newColumnName="keyword" columnDataType="varchar(60)"/>
        <renameColumn tableName="links" oldColumnName="tipo"
                  newColumnName="type" columnDataType="varchar(50)"/>        
    </changeSet>    

    
    <changeSet author="vifito" id="1271699110">
        <tagDatabase tag="0.1"/>
    </changeSet>
</databaseChangeLog>