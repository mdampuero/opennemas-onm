(function(){angular.module("onm.sidebar",[]).directive("sidebar",["$compile","$http","$location","$rootScope","$window","history","routing",function($compile,$http,$location,$rootScope,$window,history,routing){return{restrict:"E",scope:{ngModel:"="},link:function($scope,elm,attrs){var defaultSidebarTpl='<div class="sidebar">            <div class="spinner-wrapper">              <div class="spinner">                <i class="fa fa-circle-o-notch fa-3x fa-spin"></i>              </div>            </div>          </div>';var footerTpl='<div class="sidebar-footer-widget">            <ul>              <li class="profile-info">                <a ng-href="'+routing.ngGenerate("manager_user_show",{id:"me"})+'">                  <div class="profile-pic">                    <img class="gravatar" email="[% $parent.user.email %]" image="1" size="32" width=32 height=32 >                  </div>                  <div class="username">                    [% $parent.user.name %]                  </div>                </a>                <div class="logout" ng-click="$parent.logout();">                  <i class="fa fa-power-off"></i>                </div>              </li>            </ul>          </div>';var itemTpl='<li ng-class="{\'active open\': [urls]}"[click]>            <a ng-href="#">              <i class="fa[icon-class]"[spinner]></i>              <span class="title">[name]</span>              [arrow]            </a>            [submenu]          </li>';var sidebarTpl='<div class="[position][inverted]" ng-class="{ \'collapsed\': ngModel.isCollapsed() }">            <div class="[class]"[id][swipeable]>              <div class="overlay"></div>              <scrollable>                <div class="sidebar-wrapper">                  <ul>                    [items]                  </ul>                </div>              </scrollable>              [footer]            </div>            [border]          </div>';if(!attrs["src"]){return}var dft=$compile(defaultSidebarTpl)($scope);elm.replaceWith(dft);var url=routing.generate(attrs["src"]);return $http.get(url).then(function(response){$scope.ngModel={changing:{},collapsed:false,data:response.data,footer:attrs["footer"]=="true"?attrs["footer"]:false,forced:false,id:attrs["id"]?attrs["id"]:null,inverted:attrs["inverted"]=="true"?attrs["inverted"]:false,"class":attrs["class"]?attrs["class"]:"sidebar",pinnable:attrs["pinnable"]=="true"?attrs["pinnable"]:true,pinned:false,position:attrs["position"]?attrs["position"]:"left",swipeable:attrs["swipeable"]=="true"?attrs["swipeable"]:true,threshold:992,changed:function(){this.changing={}},check:function(){this.forced=false;this.collapsed=this.pinned;if($window.innerWidth<this.threshold){this.forced=true;this.collapsed=true}},close:function(){this.collapsed=true},"default":function(){return defaultSidebarTpl},init:function(route){return $http.get(routing.generate(route)).then(function(response){angular.extend(sidebar.model,response.data)})},isActive:function(url){return $location.path()==url.replace("#","")},isChanging:function(route){return this.changing&&this.changing[route]},isCollapsed:function(){return this.collapsed},itemClick:function(route){var url=routing.ngGenerateShort(route);history.clear(url);if(!this.changing[route]&&!this.isActive(url)){this.changing[route]=true}this.collapsed=this.pinned;if(this.forced){this.collapsed=true}},mouseEnter:function(){this.collapsed=false},mouseLeave:function(){this.collapsed=this.pinned;if(this.forced){this.collapsed=true}},open:function(){this.collapsed=false},pin:function(){this.pinned=!this.pinned;this.collapsed=this.pinned},renderItem:function(item){var arrow="";var click="";var iconClass="";var li=itemTpl;var spinner="";var submenu="";var urls=[];if(item.route){urls.push("ngModel.isActive('"+routing.ngGenerateShort(item.route)+"')")}if(item.items&&item.items.length>0){for(var i=0;i<item.items.length;i++){if(item.items[i].route){urls.push("ngModel.isActive('"+routing.ngGenerateShort(item.items[i].route)+"')")}}}urls=urls.join(" || ");if(item.route&&item.click){click=" ng-click=\"ngModel.itemClick('"+item.route+"')\""}if(item.route){li=li.replace("#",routing.ngGenerate(item.route))}if(item.icon){iconClass=" "+item.icon}if(item.route){spinner=" ng-class=\"{ 'fa-spin fa-circle-o-notch': ngModel.isChanging('"+item.route+"')}\""}if(item.items&&item.items.length>0){arrow='<span class="arrow" ng-class="{ \'open\':'+urls+'}"></span>';submenu+='<ul class="sub-menu">';for(var i=0;i<item.items.length;i++){submenu+=this.renderItem(item.items[i])}submenu+="</ul>"}li=li.replace("[urls]",urls);li=li.replace("[click]",click);li=li.replace("[icon-class]",iconClass);li=li.replace("[spinner]",spinner);li=li.replace("[name]",item.name);li=li.replace("[arrow]",arrow);li=li.replace("[submenu]",submenu);return li},renderSidebar:function(){var border="";var div=sidebarTpl;var id="";var inverted="";var footer="";var items="";var position="";var swipeable="";if(this.id){id=' id="'+this.id+'"'}if(this.position!="left"){position=" on-right"}if(this.inverted){inverted=" inverted"}if(this.swipeable){if(this.position=="left"){swipeable=' ng-swipe-left="ngModel.mouseLeave()" ng-swipe-right="ngModel.mouseEnter()"'}else{swipeable=' ng-swipe-left="ngModel.mouseEnter()" ng-swipe-right="ngModel.mouseLeave()"'}}if(this.footer){footer=footerTpl}if(this.pinnable){border='<div class="sidebar-border ng-cloak"></div>'}for(var i=0;i<this.data.items.length;i++){items+=this.renderItem(this.data.items[i])}div=div.replace("[class]",this.class);div=div.replace("[id]",id);div=div.replace("[footer]",footer);div=div.replace("[border]",border);div=div.replace("[items]",items);div=div.replace("[inverted]",inverted);div=div.replace("[position]",position);div=div.replace("[swipeable]",swipeable);div=div.replace("[ngModel]",attrs["ngModel"]);return div},render:function(){return this.renderSidebar(this.model)},toggle:function(){if(this.collapsed){this.open()}else{this.close()}}};$rootScope.$on("$routeChangeSuccess",function(event,next,current){$scope.ngModel.changed()});$scope.$watch(function(){return $window.innerWidth},function(nv,ov){$scope.ngModel.check()});var html=$scope.ngModel.render();var e=$compile(html)($scope);e.find(".sidebar").bind("mouseenter",function(){$scope.ngModel.mouseEnter();$scope.$apply()});e.find(".sidebar").bind("mouseleave",function(){$scope.ngModel.mouseLeave();$scope.$apply()});e.find("li > a").on("click",function(e){var item=$(this).parent();var visible=item.hasClass("open");var submenu=$(this).next();item.parent().find("li.open .arrow.open").removeClass("open");item.parent().find("li.open .sub-menu").slideUp(200,function(){item.parent().find("li.open").removeClass("open")});if($(this).next().hasClass("sub-menu")===false){return}if(!visible){item.find(".arrow").first().addClass("open");submenu.slideDown(200,function(){item.addClass("open")})}e.preventDefault()});dft.replaceWith(e);if($scope.ngModel.pinnable){e.find(".sidebar-border").on("click",function(e){$scope.ngModel.pin();$scope.$apply()})}})}}}])})();