<?php
namespace Framework\Tests\Models;

use Common\Core\Component\Locale\Locale;
use Common\Model\Entity\Category;

/**
 * Generated by PHPUnit_SkeletonGenerator on 2012-05-31 at 02:56:38.
 */
class ContentTest extends \PHPUnit\Framework\TestCase
{
    /**
     * @var Content
     */
    protected $object;

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    protected function setUp()
    {
        $this->config = [
            'backend'  => [
                'language' => [
                    'available' => [ 'en_US', 'es_ES' ],
                    'selected'  => 'en_US',
                    'slug'      => []
                ],
                'timezone' => 'UTC'
            ],
            'frontend' => [
                'language' => [
                    'available' => [ 'en_US', 'es_ES' ],
                    'selected'  => 'en_US',
                    'slug'      => []
                ],
                'timezone' => 'UTC'
            ]
        ];

        $this->locale = new Locale($this->config, '/wubble/flob');
        $this->locale->configure([
            'frontend' => [
                'language' => [
                    'selected'  => 'en',
                    'available' => [ 'en', 'es' ],
                ]
            ]
        ]);

        $this->cache = $this->getMockBuilder('Cache')
            ->setMethods([ 'fetch' ])
            ->getMock();
        $this->cache->expects($this->any())->method('fetch')
            ->willReturn([]);

        $this->container = $this->getMockBuilder('ServiceContainer')
            ->setMethods([ 'get', 'hasParameter' ])
            ->getMock();

        $this->conn = $this->getMockBuilder('DatabaseConnection')
            ->setMethods([ 'fetchAll' ])
            ->getMock();

        $this->conn->expects($this->any())->method('fetchAll')
            ->willReturn([]);

        $this->fm = $this->getMockBuilder('Opennemas\Data\Filter\FilterManager')
            ->disableOriginalConstructor()
            ->setMethods([ 'filter', 'get', 'set' ])
            ->getMock();

        $this->instance = $this->getMockBuilder('Instance')
            ->setMethods([ 'hasMultilanguage' ])
            ->getMock();

        $this->kernel = $this->getMockBuilder('Kernel')
            ->setMethods([ 'getContainer' ])
            ->getMock();

        $this->service = $this->getMockBuilder('CategoryService')
            ->setMethods([ 'getItem' ])
            ->getMock();

        $this->container->expects($this->any())->method('get')
            ->will($this->returnCallback([ $this, 'serviceContainerCallback' ]));
        $this->fm->expects($this->any())->method('set')
            ->willReturn($this->fm);
        $this->fm->expects($this->any())->method('filter')
            ->willReturn($this->fm);
        $this->kernel->expects($this->any())->method('getContainer')
            ->willReturn($this->container);

        $GLOBALS['kernel'] = $this->kernel;

        $this->object = new \Content;
    }

    public function serviceContainerCallback($name)
    {
        switch ($name) {
            case 'api.service.category':
                return $this->service;
            case 'core.instance':
                return $this->instance;
            case 'core.locale':
                return $this->locale;
            case 'data.manager.filter':
                return $this->fm;
            case 'dbal_connection':
                return $this->conn;
            case 'cache':
                return $this->cache;
        }

        return null;
    }

    public function testGetAndSetWhenNoMultilanguage()
    {
        $content  = new \Content();
        $property = new \ReflectionProperty($content, 'title');

        $property->setAccessible(true);

        $this->instance->expects($this->any())->method('hasMultilanguage')
            ->willReturn(false);

        $content->title          = 'fred';
        $content->content_status = 1;

        $this->assertEquals('fred', $property->getValue($content));
        $this->assertEquals('fred', $content->title);
        $this->assertEquals(1, $content->content_status);

        $content->title             = [ 'en' => 'mumble' ];
        $content->content_status    = 1;
        $content->content_type_name = 'article';

        $this->assertEquals(1, $content->content_status);

        $this->fm->expects($this->at(2))->method('get')
            ->willReturn('mumble');


        $this->assertEquals([ 'en' => 'mumble' ], $property->getValue($content));
        $this->assertEquals('mumble', $content->title);
    }

    public function testGetAndSetWhenMultilanguage()
    {
        $content  = new \Content();
        $property = new \ReflectionProperty($content, 'title');

        $property->setAccessible(true);

        $this->instance->expects($this->any())->method('hasMultilanguage')
            ->willReturn(true);

        // No multiple languages in database
        $property->setValue($content, 'fred');

        $content->content_status    = 1;
        $content->content_type_name = 'article';

        $this->fm->expects($this->at(2))->method('get')
            ->willReturn([ 'en' => 'fred' ]);

        $this->assertEquals('fred', $property->getValue($content));
        $this->assertEquals([ 'en' => 'fred' ], $content->title);
        $this->assertEquals(1, $content->content_status);

        $this->fm->expects($this->at(2))->method('get')
            ->willReturn([ 'en' => 'fred' ]);

        // Multiple languages in database
        $content->title = 'fred';

        $this->fm->expects($this->at(2))->method('get')
            ->willReturn([ 'en' => 'fred' ]);

        $this->assertEquals([ 'en' => 'fred' ], $property->getValue($content));
        $this->assertEquals([ 'en' => 'fred' ], $content->title);
    }

    /**
     * @covers Content::getStatus
     */
    public function testGetStatus()
    {
        $content            = new \Content();
        $content->in_litter = 1;
        $this->assertEquals(\Content::TRASHED, $content->getStatus());

        $content = new \Content();
        $this->assertEquals(\Content::PENDING, $content->getStatus());

        $content                 = new \Content();
        $content->content_status = 1;
        $this->assertEquals(\Content::AVAILABLE, $content->getStatus());
    }

    public function testLoad()
    {
        $this->service->expects($this->any())->method('getItem')
            ->willReturn(new Category([
                'name'  => 'grault',
                'title' => 'Grault'
            ]));

        $content = new \Content();
        $content->load([
            'title'                  => 'a:2:{s:2:"en";s:3:"bar";s:2:"es";s:4:"gorp";}',
            'pk_content'             => 123,
            'other_value'            => 'other value',
            'fk_content_type'        => 1,
            'category_id'            => 2,
            'params'                 => 'a:2:{s:4:"test";i:1;s:5:"test2";i:2;}',
            'category_slug'          => 'testing',
        ]);
        $this->assertEquals(123, $content->id);
        $this->assertEquals('other value', $content->other_value);
        $this->assertEquals(1, $content->content_type);
        $this->assertEquals(2, $content->category_id);
        $this->assertEquals([ 'test' => 1, 'test2' => 2 ], $content->params);

        $property = new \ReflectionProperty($content, 'title');
        $property->setAccessible(true);

        $this->assertEquals([ 'en' => 'bar', 'es' => 'gorp' ], $property->getValue($content));
    }

    /**
     * @covers Content::getSchedulingState
     */
    public function testGetSchedulingStateWithNulledZeroedArticle()
    {
        $now = '2012-08-22 03:03:12';

        $content            = new \Content();
        $content->starttime = null;
        $content->endtime   = '2012-08-22 03:03:12';
        $this->assertEquals(\Content::NOT_SCHEDULED, $content->getSchedulingState($now));

        $content->starttime = null;
        $content->endtime   = '2012-08-21 03:03:12';
        $this->assertEquals(\Content::NOT_SCHEDULED, $content->getSchedulingState($now));

        $content->starttime = null;
        $content->endtime   = '2012-08-23 03:03:12';
        $this->assertEquals(\Content::NOT_SCHEDULED, $content->getSchedulingState($now));

        $content->starttime = null;
        $content->endtime   = null;
        $this->assertEquals(\Content::NOT_SCHEDULED, $content->getSchedulingState($now));

        $content->starttime = '2012-08-23 03:03:12';
        $content->endtime   = '2012-08-23 03:03:12';
        $this->assertEquals(\Content::NOT_SCHEDULED, $content->getSchedulingState($now));
    }

    /**
     * @covers Content::getSchedulingState
     */
    public function testGetSchedulingStateWithDuedArticle()
    {
        // Check scheduling state with dued article with valid starttime
        $content            = new \Content();
        $content->starttime = '2013-08-20 03:03:12';
        $content->endtime   = '2012-08-21 03:03:12';
        $this->assertEquals(\Content::DUED, $content->getSchedulingState());
    }

    /**
     * @covers Content::getSchedulingState
     */
    public function testGetSchedulingStateWithInTimeArticle()
    {
        $content            = new \Content();
        $content->starttime = '2012-08-20 03:03:12';
        $content->endtime   = null;

        $this->assertEquals(\Content::IN_TIME, $content->getSchedulingState());

        $content            = new \Content();
        $content->starttime = '2012-08-20 03:03:12';
        $content->endtime   = '3012-08-20 03:03:12';

        $this->assertEquals(\Content::IN_TIME, $content->getSchedulingState());
    }

    /*
     * @covers Content::getSchedulingState
     */
    public function testGetSchedulingStateWithPostponedArticle()
    {
        $content            = new \Content();
        $content->starttime = '3013-08-22 03:03:12';
        $content->endtime   = null;

        $this->assertEquals(\Content::POSTPONED, $content->getSchedulingState());
    }

    /**
     * @covers Content::isScheduled
     */
    public function testIsScheduled()
    {
        $content = new \Content();

        $method = new \ReflectionMethod($content, 'isScheduled');
        $method->setAccessible(true);

        //  now    start    end
        // --|-------(-------)--
        $content->starttime = '2012-08-23 03:03:12';
        $content->endtime   = '2012-08-25 03:03:12';
        $this->assertTrue($method->invokeArgs($content, []));

        // start    now     end
        // --(-------|-------)--
        $content->starttime = '2012-08-21 03:03:12';
        $content->endtime   = '2012-08-25 03:03:12';
        $this->assertTrue($method->invokeArgs($content, []));

        // start    end     now
        // --(-------)-------|--
        $content->starttime = '2012-08-20 03:03:12';
        $content->endtime   = '2012-08-21 03:03:12';
        $this->assertTrue($method->invokeArgs($content, []));

        //  now    start
        // --|-------(----------
        $content->starttime = '2012-08-23 03:03:12';
        $content->endtime   = null;
        $this->assertTrue($method->invokeArgs($content, []));

        // start    now
        // --(-------|----------
        $content->starttime = '2012-08-21 03:03:12';
        $content->endtime   = null;
        $this->assertTrue($method->invokeArgs($content, []));

        $content->starttime = null;
        $content->endtime   = null;
        $this->assertFalse($method->invokeArgs($content, []));

        $content->starttime = null;
        $content->endtime   = '2012-08-21 03:03:12';
        $this->assertFalse($method->invokeArgs($content, []));

        $content->starttime = '2012-08-21 03:03:12';
        $content->endtime   = '2012-08-21 03:03:12';
        $this->assertFalse($method->invokeArgs($content, []));
    }

    /**
     * @covers Content::isDued
     */
    public function testIsDued()
    {
        $content = new \Content();

        $method = new \ReflectionMethod($content, 'isDued');
        $method->setAccessible(true);

        $content->starttime = null;
        $content->endtime   = '2012-08-21 03:03:12';
        $this->assertTrue($method->invokeArgs($content, []));

        $content->starttime = null;
        $content->endtime   = '3012-01-01 00:00:00';
        $this->assertFalse($method->invokeArgs($content, []));
    }

    /**
     * @covers Content::isInTime
     */
    public function testIsInTime()
    {
        $content = new \Content();

        $content->starttime = null;
        $content->endtime   = null;
        $this->assertTrue($content->isInTime());

        $content->starttime = null;
        $content->endtime   = '2012-08-23 03:03:12';
        $this->assertFalse($content->isInTime());

        $content->starttime = null;
        $content->endtime   = '3012-08-21 03:03:12';
        $this->assertTrue($content->isInTime());

        $content->starttime = '2012-08-21 03:03:12';
        $content->endtime   = '2012-08-23 03:03:12';
        $this->assertFalse($content->isInTime());

        $content->starttime = '2012-08-21 03:03:12';
        $content->endtime   = '2012-08-21 03:03:12';
        $this->assertFalse($content->isInTime());

        $content->starttime = '2012-08-21 03:03:12';
        $content->endtime   = null;
        $this->assertTrue($content->isInTime());

        $content->starttime = '2012-08-21 03:03:12';
        $content->endtime   = '3012-08-21 03:03:12';
        $this->assertTrue($content->isInTime());
    }

    /**
     * @covers Content::isPostponed
     */
    public function testIsPostponed()
    {
        $content = new \Content();

        $method = new \ReflectionMethod($content, 'isPostponed');
        $method->setAccessible(true);

        $content->starttime = '2012-08-21 03:03:12';
        $this->assertFalse($method->invokeArgs($content, []));

        $content->starttime = null;
        $this->assertFalse($method->invokeArgs($content, []));

        $content->starttime = '3012-08-24 03:03:12';
        $this->assertTrue($method->invokeArgs($content, []));
    }

    /**
     * @covers Content::isSuggested
     */
    public function testIsSuggested()
    {
        $content            = new \Content();
        $content->frontpage = 1;
        $this->assertTrue($content->isSuggested());

        $content->frontpage = 0;
        $this->assertFalse($content->isSuggested());
    }

    /**
     * @covers Content::getContentTypeName
     */
    public function testGetContentTypeName()
    {
        $content               = new \Content();
        $content->content_type = 1;

        $contentTypeName = $content->getContentTypeName();

        $this->assertEquals('article', $contentTypeName);
    }

    /**
     * @covers Content::getContentTypeName
     */
    public function testGetContentTypeNameWithEmptyContentType()
    {
        $content               = new \Content();
        $content->content_type = '';

        $contentTypeName = $content->getContentTypeName();

        $this->assertEquals(false, $contentTypeName);
    }

    /**
     * @covers Content::getContentTypeName
     */
    public function testGetContentTypeNameWithNotValidContentType()
    {
        $content               = new \Content();
        $content->content_type = -1;

        $contentTypeName = $content->getContentTypeName();

        $this->assertEquals(false, $contentTypeName);
    }

    /**
     * @covers Content::isReadyForPublish
     */
    public function testIsReadyForPublish()
    {
        $content = new \Content();

        // Content in time, available and not in litter
        $content->starttime      = '2012-08-21 03:03:12';
        $content->endtime        = '';
        $content->content_status = 1;
        $content->in_litter      = 0;
        $this->assertTrue($content->isReadyForPublish());

        // Content not available
        $content->starttime      = '2052-08-21 03:03:12';
        $content->endtime        = '';
        $content->content_status = 0;
        $content->in_litter      = 0;
        $this->assertFalse($content->isReadyForPublish());

        // Content in litter
        $content->starttime      = '2052-08-21 03:03:12';
        $content->endtime        = '';
        $content->content_status = 1;
        $content->in_litter      = 1;
        $this->assertFalse($content->isReadyForPublish());

        // Content available but with an endtime in the past
        $content->starttime      = '';
        $content->endtime        = '1912-08-21 03:03:12';
        $content->content_status = 1;
        $content->in_litter      = 0;
        $this->assertFalse($content->isReadyForPublish());
    }

    /**
     * @covers Content::isOwner()
     */
    public function testIsOwner()
    {
        // Check that the content belongs to publisher 4
        $content = new \Content();
        $content->load([
            'fk_publisher' => 4,
        ]);

        $this->assertTrue($content->isOwner(4));

        // Check that the content belongs to the author 4
        $content = new \Content();
        $content->load([
            'fk_publisher' => 4,
            'fk_author'    => 5,
        ]);

        $this->assertTrue($content->isOwner(5));

        // Check that the content doesnt belong to a unexisting user
        $content = new \Content();
        $content->load([
            'fk_publisher' => 4,
            'fk_author'    => 5,
        ]);

        $this->assertFalse($content->isOwner(40));
    }
}
